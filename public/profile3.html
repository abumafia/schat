<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil - UniConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .gradient-bg{ background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .diamond-avatar{ clip-path: polygon(50% 0%,100% 50%,50% 100%,0% 50%); }
    .profile-tab{ transition: all .3s ease; }
    .profile-tab.active{ background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
    .edit-input:focus{ box-shadow:0 0 0 3px rgba(102,126,234,.2); }

    /* Robot preview */
    .robot-wrap{
      display:flex; gap:16px; align-items:center;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      padding:14px 16px;
      background: linear-gradient(180deg, rgba(124,58,237,.08), rgba(99,102,241,.06));
    }
    .robot-svg{
      width:84px; height:84px; flex: 0 0 auto;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.12));
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.7);
      font-size: 12px;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="gradient-bg text-white h-16">
    <div class="container mx-auto px-4 h-full flex items-center justify-between">
      <a href="/messages.html" class="flex items-center space-x-2">
        <i class="fas fa-arrow-left"></i>
        <span class="font-semibold">Xabarlarga qaytish</span>
      </a>
      <div class="flex items-center space-x-4">
        <button onclick="saveProfile()" id="saveBtn"
          class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition hidden">
          <i class="fas fa-save mr-2"></i> Saqlash
        </button>
        <a href="#" onclick="logout()" class="p-2 hover:bg-white/10 rounded-full">
          <i class="fas fa-sign-out-alt"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- Profile Container -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Profile Header -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
      <!-- Cover Photo -->
      <div id="coverPhoto" class="h-48 gradient-bg relative" style="background-size:cover;background-position:center;">
        <button id="changeCoverBtn" onclick="changeCoverPhoto()"
          class="absolute top-4 right-4 bg-white/20 backdrop-blur-sm text-white px-4 py-2 rounded-lg hover:bg-white/30 transition">
          <i class="fas fa-camera mr-2"></i> Cover o‘zgartirish
        </button>
      </div>

      <!-- Profile Info -->
      <div class="px-8 pb-8 -mt-16 relative">
        <!-- Avatar -->
        <div class="relative inline-block">
          <img id="profileAvatar" src="https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png"
            class="w-32 h-32 diamond-avatar border-4 border-white shadow-lg">
          <button id="changeAvatarBtn" onclick="changeAvatar()"
            class="absolute bottom-2 right-2 bg-purple-600 text-white p-2 rounded-full hover:bg-purple-700 transition">
            <i class="fas fa-camera text-sm"></i>
          </button>
        </div>

        <!-- Profile Details -->
        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <div>
              <h1 id="profileName" class="text-2xl font-bold text-gray-800"></h1>
              <p id="profileUsername" class="text-gray-600">@username</p>
            </div>
            <div class="flex items-center space-x-2">
              <div id="onlineStatus" class="flex items-center px-3 py-1 rounded-full text-sm">
                <span class="w-2 h-2 rounded-full mr-2 bg-gray-400"></span>
                <span>Offline</span>
              </div>
            </div>
          </div>

          <p id="profileBio" class="text-gray-700 mb-4"></p>

          <!-- Robot preview -->
          <div class="robot-wrap mb-6">
            <svg id="robotSvg" class="robot-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="rbG" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0" stop-color="#7c3aed"/>
                  <stop offset="1" stop-color="#4f46e5"/>
                </linearGradient>
              </defs>
              <rect x="22" y="26" rx="18" ry="18" width="76" height="70" fill="url(#rbG)" opacity="0.96"/>
              <rect x="32" y="38" rx="12" ry="12" width="56" height="34" fill="rgba(255,255,255,0.18)"/>
              <circle id="eyeL" cx="50" cy="55" r="6" fill="white"/>
              <circle id="eyeR" cx="70" cy="55" r="6" fill="white"/>
              <circle cx="50" cy="55" r="2.6" fill="rgba(15,23,42,0.85)"/>
              <circle cx="70" cy="55" r="2.6" fill="rgba(15,23,42,0.85)"/>
              <path id="mouth" d="M48 70 Q60 78 72 70" stroke="rgba(255,255,255,0.92)" stroke-width="4" fill="none" stroke-linecap="round"/>
              <rect x="54" y="12" width="12" height="10" rx="5" fill="rgba(255,255,255,0.45)"/>
              <circle cx="60" cy="10" r="6" fill="rgba(255,255,255,0.65)"/>
            </svg>

            <div class="flex-1">
              <div class="flex flex-wrap gap-2 mb-2">
                <span class="pill"><i class="fa-solid fa-shirt"></i> Outfit: <b id="robotOutfit">basic</b></span>
                <span class="pill"><i class="fa-solid fa-palette"></i> Rang: <b id="robotColor">#7c3aed</b></span>
                <span class="pill"><i class="fa-solid fa-face-smile"></i> Kayfiyat: <b id="robotMood">neutral</b></span>
              </div>
              <div class="text-sm text-gray-600" id="robotHint">
                Bu foydalanuvchining robotchasi. Kiyimi/rangi “Pet Market”dan olingan bo‘lishi mumkin.
              </div>
            </div>
          </div>

          <!-- Stats -->
          <div class="flex space-x-6 mb-6">
            <div class="text-center">
              <div class="text-xl font-bold text-gray-800" id="friendsCount">0</div>
              <div class="text-sm text-gray-600">Do‘stlar</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-gray-800" id="groupsCount">0</div>
              <div class="text-sm text-gray-600">Guruhlar</div>
            </div>
            <div class="text-center">
              <div class="text-xl font-bold text-gray-800" id="messagesCount">0</div>
              <div class="text-sm text-gray-600">Xabarlar</div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-3">
            <button onclick="editProfile()" id="editBtn"
              class="gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">
              <i class="fas fa-edit mr-2"></i> Profilni tahrirlash
            </button>
            <button onclick="shareProfile()"
              class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-50 transition">
              <i class="fas fa-share-alt mr-2"></i> Ulashish
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Tabs -->
    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
      <button onclick="switchTab('info')" class="profile-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap active">
        <i class="fas fa-info-circle mr-2"></i> Asosiy
      </button>
      <button onclick="switchTab('education')" class="profile-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
        <i class="fas fa-graduation-cap mr-2"></i> Ta’lim
      </button>
      <button onclick="switchTab('settings')" class="profile-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
        <i class="fas fa-cog mr-2"></i> Sozlamalar
      </button>
      <button onclick="switchTab('activity')" class="profile-tab px-6 py-3 font-medium text-gray-600 hover:text-purple-600 whitespace-nowrap">
        <i class="fas fa-chart-line mr-2"></i> Faollik
      </button>
    </div>

    <!-- Tab Content -->
    <div id="tabContent">
      <!-- Basic Info Tab -->
      <div id="infoTab" class="space-y-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Shaxsiy ma’lumotlar</h3>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">To‘liq ism</label>
              <input type="text" id="editFullName" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="To‘liq ism">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nickname</label>
              <input type="text" id="editNickname" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Nickname">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
              <div class="relative">
                <span class="absolute left-3 top-3 text-gray-400">@</span>
                <input type="text" id="editUsername" class="w-full pl-8 px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="username">
                <div class="text-xs text-gray-500 mt-1" id="usernameChangeInfo">
                  Username 15 kunda 1 marta o‘zgaradi
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Telefon</label>
              <input type="tel" id="editPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Telefon raqam">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input type="email" id="editEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Email">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
              <textarea id="editBio" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="O‘zingiz haqingizda..."></textarea>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Maxfiylik</h3>
          <div class="space-y-4">
            <label class="flex items-center justify-between">
              <div>
                <span class="font-medium text-gray-700">Profil ko‘rinishi</span>
                <p class="text-sm text-gray-500">Kimlar ko‘ra oladi?</p>
              </div>
              <select id="profileVisibility" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="public">Hamma</option>
                <option value="university">Faqat universitet</option>
                <option value="friends">Faqat do‘stlar</option>
                <option value="private">Yashirin</option>
              </select>
            </label>

            <label class="flex items-center">
              <input type="checkbox" id="showOnlineStatus" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="ml-2 text-gray-700">Online holatni ko‘rsatish</span>
            </label>

            <label class="flex items-center">
              <input type="checkbox" id="showLastSeen" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="ml-2 text-gray-700">Oxirgi kirishni ko‘rsatish</span>
            </label>

            <label class="flex items-center">
              <input type="checkbox" id="allowMessageRequests" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
              <span class="ml-2 text-gray-700">Hammadan xabar so‘rovlari</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Education Tab -->
      <div id="educationTab" class="space-y-6 hidden">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Universitet</h3>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Universitet</label>
              <select id="editUniversity" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                <option value="">Tanlang</option>
                <option value="Other">Boshqa</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Guruh/Sinf</label>
              <input type="text" id="editStudyGroup" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Masalan: 201-A">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Yo‘nalish</label>
              <input type="text" id="editMajor" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Masalan: Dasturlash">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Kurs</label>
              <select id="editYear" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500">
                <option value="">Tanlang</option>
                <option value="1">1-kurs</option>
                <option value="2">2-kurs</option>
                <option value="3">3-kurs</option>
                <option value="4">4-kurs</option>
                <option value="mag">Magistr</option>
              </select>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-gray-800 text-lg">Fanlar</h3>
            <button onclick="addCourse()" class="text-purple-600 hover:text-purple-800 text-sm font-medium">
              <i class="fas fa-plus mr-1"></i> Qo‘shish
            </button>
          </div>
          <div id="coursesList" class="space-y-3">
            <div class="text-center py-4 text-gray-500">
              <i class="fas fa-book-open text-2xl mb-2"></i>
              <p>Hozircha yo‘q</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Qiziqishlar</h3>
          <div class="space-y-4">
            <textarea id="studyInterests" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg edit-input focus:border-purple-500 focus:ring-1 focus:ring-purple-500" placeholder="Nimalarga qiziqasiz?"></textarea>
            <div class="flex flex-wrap gap-2" id="interestTags"></div>
            <div class="text-sm text-gray-500">O‘xshash qiziqishli hamkor topish uchun</div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="settingsTab" class="space-y-6 hidden">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Akkaunt</h3>
          <div class="space-y-4">
            <button onclick="changePassword()" class="w-full text-left p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium text-gray-800">Parolni o‘zgartirish</div>
                  <div class="text-sm text-gray-500">Akkaunt xavfsizligi</div>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
              </div>
            </button>

            <button onclick="deleteAccount()" class="w-full text-left p-3 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition">
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-medium">Akkauntni o‘chirish</div>
                  <div class="text-sm">Qaytarib bo‘lmaydi</div>
                </div>
                <i class="fas fa-chevron-right"></i>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- Activity Tab -->
      <div id="activityTab" class="space-y-6 hidden">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-6">Faollik</h3>
          <div class="grid md:grid-cols-3 gap-6">
            <div class="text-center p-4 bg-purple-50 rounded-lg">
              <div class="text-2xl font-bold text-purple-600" id="totalActivity">0</div>
              <div class="text-sm text-gray-600">Xabarlar</div>
            </div>
            <div class="text-center p-4 bg-blue-50 rounded-lg">
              <div class="text-2xl font-bold text-blue-600" id="activeDays">0</div>
              <div class="text-sm text-gray-600">Faol kunlar</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <div class="text-2xl font-bold text-green-600" id="avgMessages">0</div>
              <div class="text-sm text-gray-600">Kunlik o‘rtacha</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="font-bold text-gray-800 text-lg mb-4">Oxirgi harakatlar</h3>
          <div id="activityList" class="space-y-3">
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-history text-2xl mb-2"></i>
              <p>Hozircha yo‘q</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Avatar Modal (old) -->
  <div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-md">
      <div class="p-6">
        <h3 class="text-xl font-bold mb-4">Avatar o‘zgartirish</h3>
        <div class="space-y-4">
          <div class="text-center">
            <img id="currentAvatar" src="" class="w-32 h-32 diamond-avatar mx-auto mb-4">
          </div>
          <div class="space-y-3">
            <button onclick="uploadNewAvatar()" class="w-full border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-purple-500 hover:bg-purple-50 transition text-center">
              <i class="fas fa-upload text-2xl text-gray-400 mb-2"></i>
              <div class="font-medium text-gray-700">Yangi rasm yuklash</div>
              <div class="text-sm text-gray-500">JPG/PNG 5MB</div>
            </button>
            <div class="grid grid-cols-4 gap-2">
              <button onclick="selectAvatar('https://api.dicebear.com/7.x/avataaars/svg?seed=1')" class="p-2 border border-gray-300 rounded-lg hover:border-purple-500">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=1" class="w-full rounded">
              </button>
              <button onclick="selectAvatar('https://api.dicebear.com/7.x/avataaars/svg?seed=2')" class="p-2 border border-gray-300 rounded-lg hover:border-purple-500">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=2" class="w-full rounded">
              </button>
              <button onclick="selectAvatar('https://api.dicebear.com/7.x/avataaars/svg?seed=3')" class="p-2 border border-gray-300 rounded-lg hover:border-purple-500">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=3" class="w-full rounded">
              </button>
              <button onclick="selectAvatar('https://api.dicebear.com/7.x/avataaars/svg?seed=4')" class="p-2 border border-gray-300 rounded-lg hover:border-purple-500">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=4" class="w-full rounded">
              </button>
            </div>
          </div>

          <div class="flex space-x-3 pt-4">
            <button onclick="closeAvatarModal()" class="flex-1 border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-50 transition">Bekor</button>
            <button onclick="saveAvatar()" class="flex-1 gradient-bg text-white py-2 rounded-lg font-semibold hover:opacity-90 transition">Saqlash</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  let me = null;             // /api/me
  let profileUser = null;    // viewed profile
  let isEditing = false;
  let originalData = {};
  let currentTab = 'info';

  document.addEventListener('DOMContentLoaded', async () => {
    await checkAuth();
    await loadProfileFixed();
    setupEventListeners();
  });

  async function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = '/login.html'; return; }

    const res = await fetch('/api/me', { headers: { 'Authorization': `Bearer ${token}` } });
    if (!res.ok) { localStorage.removeItem('token'); window.location.href='/login.html'; return; }
    const data = await res.json();
    if (!data.success) { localStorage.removeItem('token'); window.location.href='/login.html'; return; }
    me = data.user;
  }

  // URL: profile.html?user=<id> yoki profile.html?u=<username>
  function getUserFromURL() {
    const p = new URLSearchParams(window.location.search);
    return { userId: p.get('user'), username: p.get('u') };
  }

  async function loadProfileFixed() {
    try {
      const token = localStorage.getItem('token');
      const { userId, username } = getUserFromURL();

      // 1) Agar userId/username bo‘lmasa — o‘zimniki
      if (!userId && !username) {
        profileUser = me;
        renderProfile(profileUser, true);
        loadProfileStats().catch(()=>{});
        loadActivity().catch(()=>{});
        return;
      }

      // 2) Boshqa user: serverdan alohida olib kelamiz
      let endpoint = '';
      if (userId) endpoint = `/api/user/${userId}`;
      else endpoint = `/api/user/by-username/${encodeURIComponent(username)}`;

      const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();

      if (!res.ok || !data.success) {
        alert(data.message || "Profil ochilmadi");
        // fallback: o‘zimga qayt
        window.location.href = '/profile.html';
        return;
      }

      profileUser = data.user;
      const isOwn = (String(me?._id) === String(profileUser?._id));

      renderProfile(profileUser, isOwn);

      if (!isOwn) {
        lockOtherUserView(profileUser);
      } else {
        loadProfileStats().catch(()=>{});
        loadActivity().catch(()=>{});
      }
    } catch (e) {
      console.error('loadProfileFixed error:', e);
      alert("Profilni yuklashda xatolik");
    }
  }

  function lockOtherUserView(targetUser) {
    // Edit tugmalarini yashirish
    document.getElementById('saveBtn').classList.add('hidden');
    document.getElementById('changeCoverBtn').style.display = 'none';
    document.getElementById('changeAvatarBtn').style.display = 'none';
    document.getElementById('editBtn').style.display = 'none';

    // inputlarni o‘qish rejimiga o‘tkazamiz
    document.querySelectorAll('input, textarea, select').forEach(el => {
      el.disabled = true;
      el.classList.add('opacity-80');
    });

    // Chat tugmasi qo‘shamiz
    const header = document.querySelector('.mt-4');
    if (header && !document.getElementById('startChatBtn')) {
      const btn = document.createElement('button');
      btn.id = 'startChatBtn';
      btn.onclick = () => window.location.href = `/chat.html?user=${targetUser._id}`;
      btn.className = 'gradient-bg text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition';
      btn.innerHTML = '<i class="fas fa-comment mr-2"></i> Xabar yozish';
      header.querySelector('.flex.space-x-3')?.appendChild(btn);
    }

    // Settings/Activity tablarini yashirsak ham bo‘ladi (ixtiyoriy)
    // switchTab('info');
  }

  function renderProfile(user, isOwnProfile = true) {
    // Basic
    document.getElementById('profileAvatar').src = user.avatar || 'https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png';
    document.getElementById('profileName').textContent = user.fullName || user.nickname || user.username || 'Noma’lum';
    document.getElementById('profileUsername').textContent = `@${user.username || 'unknown'}`;
    document.getElementById('profileBio').textContent = user.bio || 'Bio yo‘q';

    // Cover
    if (user.coverPhoto) {
      const cp = document.getElementById('coverPhoto');
      cp.style.backgroundImage = `url('${user.coverPhoto}')`;
    }

    // Online status
    const statusDiv = document.getElementById('onlineStatus');
    const dot = statusDiv.querySelector('span');
    dot.className = `w-2 h-2 rounded-full mr-2 ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
    statusDiv.querySelector('span:last-child').textContent = user.isOnline ? 'Online' : 'Offline';

    // Fill inputs
    if (isOwnProfile) {
      document.getElementById('editFullName').value = user.fullName || '';
      document.getElementById('editNickname').value = user.nickname || '';
      document.getElementById('editUsername').value = user.username || '';
    }
    document.getElementById('editPhone').value = user.phone || '';
    document.getElementById('editEmail').value = user.email || '';
    document.getElementById('editBio').value = user.bio || '';
    document.getElementById('editUniversity').value = user.university || '';
    document.getElementById('editStudyGroup').value = user.studyGroup || '';

    // privacy values if exist
    if (typeof user.profileVisibility !== 'undefined') document.getElementById('profileVisibility').value = user.profileVisibility || 'public';
    if (typeof user.showOnlineStatus !== 'undefined') document.getElementById('showOnlineStatus').checked = !!user.showOnlineStatus;
    if (typeof user.showLastSeen !== 'undefined') document.getElementById('showLastSeen').checked = !!user.showLastSeen;
    if (typeof user.allowMessageRequests !== 'undefined') document.getElementById('allowMessageRequests').checked = !!user.allowMessageRequests;

    originalData = { ...user };
    checkUsernameChangeEligibility(user);

    // Robot/Pet render
    renderRobot(user.petState || user.pet || user.robot);
  }

  function renderRobot(petState) {
    const st = petState || { color:'#7c3aed', outfit:'basic', mood:'neutral' };
    const color = st.color || '#7c3aed';
    const outfit = st.outfit || 'basic';
    const mood = st.mood || 'neutral';

    document.getElementById('robotColor').textContent = color;
    document.getElementById('robotOutfit').textContent = outfit;
    document.getElementById('robotMood').textContent = mood;

    // Gradient update
    const svg = document.getElementById('robotSvg');
    const stops = svg.querySelectorAll('stop');
    if (stops && stops.length >= 2) {
      stops[0].setAttribute('stop-color', color);
      // ikkinchi rangni biroz “shift” qilamiz
      stops[1].setAttribute('stop-color', shadeColor(color, -18));
    }

    // Mood face
    const mouth = svg.querySelector('#mouth');
    if (mood === 'happy') mouth.setAttribute('d', 'M46 68 Q60 86 74 68');
    else if (mood === 'sad') mouth.setAttribute('d', 'M46 78 Q60 62 74 78');
    else if (mood === 'thinking') mouth.setAttribute('d', 'M48 74 Q60 74 72 74');
    else mouth.setAttribute('d', 'M48 70 Q60 78 72 70');
  }

  function shadeColor(hex, percent) {
    try {
      const h = hex.replace('#','');
      const num = parseInt(h.length===3 ? h.split('').map(x=>x+x).join('') : h, 16);
      let r = (num >> 16) & 255;
      let g = (num >> 8) & 255;
      let b = num & 255;
      r = Math.min(255, Math.max(0, r + Math.round(255 * (percent/100))));
      g = Math.min(255, Math.max(0, g + Math.round(255 * (percent/100))));
      b = Math.min(255, Math.max(0, b + Math.round(255 * (percent/100))));
      return '#' + ((1<<24) + (r<<16) + (g<<8) + b).toString(16).slice(1);
    } catch { return '#4f46e5'; }
  }

  function checkUsernameChangeEligibility(user) {
    const info = document.getElementById('usernameChangeInfo');
    const input = document.getElementById('editUsername');

    if (!info || !input) return;

    if (user.lastUsernameChange) {
      const lastChange = new Date(user.lastUsernameChange);
      const fifteenDaysAgo = new Date(); fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);
      if (lastChange > fifteenDaysAgo) {
        const next = new Date(lastChange); next.setDate(next.getDate() + 15);
        info.innerHTML = `<span class="text-yellow-600"><i class="fas fa-clock mr-1"></i> Username ${next.toLocaleDateString()} dan keyin</span>`;
        input.disabled = true;
      } else {
        info.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Username o‘zgarishi mumkin</span>`;
        input.disabled = false;
      }
    } else {
      info.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Username o‘zgarishi mumkin</span>`;
      input.disabled = false;
    }
  }

  // --------- ACTIONS (minimal stubs) ----------
  function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.profile-tab').forEach(btn => btn.classList.remove('active'));
    const tabs = ['info','education','settings','activity'];
    tabs.forEach(t => document.getElementById(t+'Tab').classList.add('hidden'));
    document.getElementById(tab+'Tab').classList.remove('hidden');

    // set active
    const idx = {info:0, education:1, settings:2, activity:3}[tab] ?? 0;
    document.querySelectorAll('.profile-tab')[idx].classList.add('active');
  }

  function editProfile() {
    isEditing = !isEditing;
    document.getElementById('saveBtn').classList.toggle('hidden', !isEditing);
  }

  async function saveProfile() {
    try {
      if (!me || !profileUser || String(me._id) !== String(profileUser._id)) return;
      const token = localStorage.getItem('token');

      const payload = {
        fullName: document.getElementById('editFullName').value.trim(),
        nickname: document.getElementById('editNickname').value.trim(),
        username: document.getElementById('editUsername').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        bio: document.getElementById('editBio').value.trim(),
        university: document.getElementById('editUniversity').value,
        studyGroup: document.getElementById('editStudyGroup').value,
        profileVisibility: document.getElementById('profileVisibility').value,
        showOnlineStatus: document.getElementById('showOnlineStatus').checked,
        showLastSeen: document.getElementById('showLastSeen').checked,
        allowMessageRequests: document.getElementById('allowMessageRequests').checked,
      };

      // Sizda update endpoint nomi boshqacha bo‘lishi mumkin:
      const res = await fetch('/api/profile/update', {
        method: 'PUT',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok || !data.success) return alert(data.message || "Saqlanmadi");

      // refresh
      me = data.user || me;
      profileUser = me;
      renderProfile(profileUser, true);
      isEditing = false;
      document.getElementById('saveBtn').classList.add('hidden');
      alert("Saqlandi");
    } catch (e) {
      console.error(e);
      alert("Xatolik: saqlab bo‘lmadi");
    }
  }

  function shareProfile() {
    if (!profileUser?._id) return;
    const url = `${location.origin}/profile.html?user=${profileUser._id}`;
    navigator.clipboard?.writeText(url).then(()=> alert("Profil havolasi nusxalandi: " + url)).catch(()=> alert(url));
  }

  function logout() {
    localStorage.removeItem('token');
    window.location.href = '/login.html';
  }

  // Modal funcs (minimal)
  function changeAvatar(){ document.getElementById('avatarModal').classList.remove('hidden'); document.getElementById('currentAvatar').src = document.getElementById('profileAvatar').src; }
  function closeAvatarModal(){ document.getElementById('avatarModal').classList.add('hidden'); }
  function selectAvatar(url){ document.getElementById('currentAvatar').src = url; }
  function uploadNewAvatar(){ alert("Upload funksiyasini serveringizdagi upload endpointga ulang"); }
  async function saveAvatar(){ alert("Avatar saqlash endpointga bog'lanmagan (sizning server nomlaringizga moslash kerak)"); closeAvatarModal(); }
  async function changeCoverPhoto(){ alert("Cover upload endpointga bog'lanmagan (sizning server nomlaringizga moslash kerak)"); }

  // Stats/Activity (agar endpoint bo‘lsa ishlaydi)
  async function loadProfileStats(){
    const token = localStorage.getItem('token');
    const res = await fetch('/api/profile/stats', { headers:{'Authorization':`Bearer ${token}`} });
    if (!res.ok) return;
    const data = await res.json();
    if (!data.success) return;
    document.getElementById('friendsCount').textContent = data.stats?.friends || 0;
    document.getElementById('groupsCount').textContent = data.stats?.groups || 0;
    document.getElementById('messagesCount').textContent = data.stats?.messages || 0;
    document.getElementById('totalActivity').textContent = data.stats?.messages || 0;
    document.getElementById('activeDays').textContent = data.stats?.activeDays || 0;
    document.getElementById('avgMessages').textContent = data.stats?.avgMessages || 0;
  }
  async function loadActivity(){ /* ixtiyoriy */ }

  function setupEventListeners(){ /* ixtiyoriy */ }
  function addCourse(){ alert("Course qo‘shish logikasi yoqilmagan"); }
  function changePassword(){ alert("Change password UI/endpoint bog'lanmagan"); }
  function deleteAccount(){ alert("Delete account endpoint bog'lanmagan"); }
</script>
</body>
</html>
