<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - UniConnect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .diamond-avatar {
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }
        .message-bubble {
            border-radius: 20px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }
        .message-bubble.sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        .message-bubble.received {
            background: #f1f5f9;
            color: #334155;
        }
        .voice-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            width: 200px;
        }
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }
        .voice-bar {
            width: 2px;
            background: white;
            border-radius: 1px;
            animation: voiceWave 1s ease-in-out infinite;
        }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes voiceWave {
            0%, 100% { height: 4px; }
            50% { height: 16px; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        /* Call UI Styles */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            flex: 1;
            padding: 20px;
        }
        
        @media (min-width: 768px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .video-container {
            position: relative;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .video-container.local video {
            transform: scaleX(-1); /* Mirror effect for local video */
        }
        
        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .call-controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1001;
        }
        
        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .call-btn:hover {
            transform: scale(1.1);
        }
        
        .call-btn.end-call {
            background: #ff4444;
            color: white;
        }
        
        .call-btn.toggle-video {
            background: #444;
            color: white;
        }
        
        .call-btn.toggle-audio {
            background: #444;
            color: white;
        }
        
        .call-btn.active {
            background: #667eea;
            color: white;
        }
        
        .call-timer {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        .incoming-call {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            z-index: 1002;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }
        
        .recording-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1003;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .file-preview {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 12px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 24px;
        }
        
        .file-info {
            flex: 1;
        }
        
        .file-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .file-size {
            font-size: 12px;
            color: #666;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white h-16">
        <div class="container mx-auto px-4 h-full flex items-center justify-between">
            <a href="/messages.html" class="flex items-center space-x-2">
                <i class="fas fa-arrow-left"></i>
                <span class="font-semibold">Back to Messages</span>
            </a>
            <div class="flex items-center space-x-4">
                <button onclick="toggleUserInfo()" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button onclick="openMediaGallery()" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-images"></i>
                </button>
                <a href="#" onclick="logout()" class="p-2 hover:bg-white/10 rounded-full">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Chat Container -->
    <div class="container mx-auto flex h-[calc(100vh-4rem)]">
        <!-- Chat Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Chat Header -->
            <div class="border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <img id="chatUserAvatar" src="https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png" 
                                 class="w-12 h-12 diamond-avatar">
                            <div id="chatUserStatus" class="w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white"></div>
                        </div>
                        <div>
                            <h1 id="chatUserName" class="text-xl font-bold text-gray-800">Loading...</h1>
                            <p id="chatUserUniversity" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Call Buttons -->
                        <button onclick="startVideoCall()" class="p-2 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-video text-gray-600"></i>
                        </button>
                        <button onclick="startVoiceCall()" class="p-2 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-phone text-gray-600"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Messages Container -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesContainer">
                <!-- Messages will be loaded here -->
                <div class="text-center mt-20">
                    <i class="fas fa-comment-dots text-4xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-500">Start Conversation</h3>
                    <p class="text-gray-400">Send your first message to begin chatting</p>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-6 pb-2">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span class="ml-2 text-sm text-gray-500" id="typingText"></span>
                </div>
            </div>
            
            <!-- Message Input Area -->
            <div class="border-t border-gray-200 p-4 bg-white">
                <!-- Voice Recording Indicator -->
                <div id="recordingIndicator" class="recording-indicator hidden">
                    <i class="fas fa-microphone"></i>
                    <span id="recordingTime">00:00</span>
                    <button onclick="stopRecording()" class="ml-4 text-sm hover:text-gray-200">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
                
                <div class="flex space-x-2">
                    <!-- Media Attachments -->
                    <div class="flex space-x-2">
                        <button onclick="attachImage()" class="p-3 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-image text-gray-600"></i>
                        </button>
                        <button onclick="attachFile()" class="p-3 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-file text-gray-600"></i>
                        </button>
                        <button onclick="startVoiceRecording()" class="p-3 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-microphone text-gray-600"></i>
                        </button>
                        <button onclick="attachLocation()" class="p-3 hover:bg-gray-100 rounded-full">
                            <i class="fas fa-map-marker-alt text-gray-600"></i>
                        </button>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="flex-1 relative">
                        <textarea id="messageInput" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="Type a message..." 
                                  rows="1"
                                  oninput="autoResize(this)"
                                  onkeydown="handleKeyDown(event)"></textarea>
                        <div class="absolute right-2 bottom-2 flex items-center space-x-1">
                            <button onclick="sendEmoji()" class="p-1 hover:bg-gray-100 rounded">
                                <i class="far fa-smile text-gray-400"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Send Button -->
                    <button onclick="sendMessage()" 
                            class="gradient-bg text-white px-6 py-3 rounded-xl font-semibold hover:opacity-90 transition self-end">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="flex justify-center space-x-4 mt-3">
                    <button onclick="sendQuickMessage('Hello! üëã')" 
                            class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition">
                        Hello! üëã
                    </button>
                    <button onclick="sendQuickMessage('Are you free to study? üìö')" 
                            class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition">
                        Study? üìö
                    </button>
                    <button onclick="sendQuickMessage('Let\'s meet on campus üè´')" 
                            class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full hover:bg-gray-200 transition">
                        Campus üè´
                    </button>
                </div>
            </div>
        </div>
        
        <!-- User Info Sidebar -->
        <div id="userInfoSidebar" class="w-80 border-l border-gray-200 bg-white overflow-y-auto hidden md:block">
            <div class="p-6">
                <!-- User Info -->
                <div class="text-center mb-8">
                    <img id="userInfoAvatar" src="" class="w-24 h-24 diamond-avatar mx-auto mb-4">
                    <h3 id="userInfoName" class="text-xl font-bold text-gray-800"></h3>
                    <p id="userInfoUsername" class="text-gray-600 mb-2"></p>
                    <div id="userInfoStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm mb-4">
                        <span class="w-2 h-2 rounded-full mr-2"></span>
                        <span>Online</span>
                    </div>
                </div>
                
                <!-- User Details -->
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">About</h4>
                        <p id="userInfoBio" class="text-gray-600"></p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">University Information</h4>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <i class="fas fa-university text-gray-400 w-5 mr-3"></i>
                                <span id="userInfoUniversity" class="text-gray-700"></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users text-gray-400 w-5 mr-3"></i>
                                <span id="userInfoStudyGroup" class="text-gray-700"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Contact</h4>
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <i class="fas fa-phone text-gray-400 w-5 mr-3"></i>
                                <span id="userInfoPhone" class="text-gray-700"></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-gray-400 w-5 mr-3"></i>
                                <span id="userInfoEmail" class="text-gray-700"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Account Created</h4>
                        <p id="userInfoCreated" class="text-gray-600"></p>
                    </div>
                    
                    <!-- Call Status -->
                    <div class="pt-4 border-t border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <span class="font-semibold text-gray-700">Call Status</span>
                            <span id="callStatus" class="text-sm text-gray-500">Ready</span>
                        </div>
                        <button onclick="startVideoCall()" 
                                class="w-full bg-purple-100 text-purple-600 py-2 rounded-lg font-medium hover:bg-purple-200 transition mb-2">
                            <i class="fas fa-video mr-2"></i> Video Call
                        </button>
                        <button onclick="startVoiceCall()" 
                                class="w-full bg-blue-100 text-blue-600 py-2 rounded-lg font-medium hover:bg-blue-200 transition">
                            <i class="fas fa-phone mr-2"></i> Voice Call
                        </button>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="pt-4 border-t border-gray-200">
                        <button onclick="viewFullProfile()" 
                                class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg font-medium hover:bg-gray-200 transition mb-2">
                            <i class="fas fa-user mr-2"></i> View Full Profile
                        </button>
                        <button onclick="blockUser()" 
                                class="w-full bg-red-100 text-red-600 py-2 rounded-lg font-medium hover:bg-red-200 transition">
                            <i class="fas fa-ban mr-2"></i> Block User
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video/Audio Call Interface -->
    <div id="callContainer" class="call-container">
        <div class="video-grid" id="videoGrid">
            <!-- Local video -->
            <div class="video-container local">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-label">You</div>
            </div>
            
            <!-- Remote video -->
            <div class="video-container remote">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label" id="remoteUserName">Connecting...</div>
            </div>
        </div>
        
        <div class="call-timer" id="callTimer">00:00</div>
        
        <div class="call-controls">
            <button id="toggleAudioBtn" class="call-btn toggle-audio active" onclick="toggleAudio()">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="toggleVideoBtn" class="call-btn toggle-video active" onclick="toggleVideo()">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-btn end-call" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="incoming-call hidden">
        <div class="mb-4">
            <img id="callerAvatar" src="" class="w-20 h-20 rounded-full mx-auto mb-2">
            <h3 id="callerName" class="text-xl font-bold">Incoming Call</h3>
            <p id="callType" class="text-gray-600">Video Call</p>
        </div>
        <div class="flex justify-center space-x-4">
            <button onclick="acceptCall()" class="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600">
                <i class="fas fa-phone mr-2"></i> Accept
            </button>
            <button onclick="rejectCall()" class="bg-red-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-600">
                <i class="fas fa-phone-slash mr-2"></i> Reject
            </button>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiPicker" class="fixed bottom-20 right-4 bg-white rounded-xl shadow-2xl border border-gray-200 hidden z-50" style="width: 320px;">
        <div class="p-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-semibold text-gray-700">Emoji Picker</h4>
                <button onclick="closeEmojiPicker()" class="p-1 hover:bg-gray-100 rounded">
                    <i class="fas fa-times text-gray-400"></i>
                </button>
            </div>
            <div class="grid grid-cols-8 gap-2">
                <!-- Emojis will be loaded here -->
                <span onclick="insertEmoji('üòÄ')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üòÄ</span>
                <span onclick="insertEmoji('üòÇ')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üòÇ</span>
                <span onclick="insertEmoji('üòç')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üòç</span>
                <span onclick="insertEmoji('ü§î')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">ü§î</span>
                <span onclick="insertEmoji('üëç')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üëç</span>
                <span onclick="insertEmoji('üëã')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üëã</span>
                <span onclick="insertEmoji('üéâ')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üéâ</span>
                <span onclick="insertEmoji('üìö')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üìö</span>
                <span onclick="insertEmoji('üíØ')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üíØ</span>
                <span onclick="insertEmoji('üî•')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üî•</span>
                <span onclick="insertEmoji('‚ú®')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">‚ú®</span>
                <span onclick="insertEmoji('‚≠ê')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">‚≠ê</span>
                <span onclick="insertEmoji('üè´')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üè´</span>
                <span onclick="insertEmoji('üíª')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üíª</span>
                <span onclick="insertEmoji('üì±')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üì±</span>
                <span onclick="insertEmoji('üéì')" class="text-xl text-center p-2 hover:bg-gray-100 rounded cursor-pointer">üéì</span>
            </div>
        </div>
    </div>

    <!-- File Upload Preview -->
    <div id="fileUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Send File</h3>
                    <button onclick="closeFileUploadModal()" class="p-2 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="filePreview" class="mb-6">
                    <!-- File preview will be shown here -->
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="closeFileUploadModal()" 
                            class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition">
                        Cancel
                    </button>
                    <button onclick="sendFile()" 
                            class="flex-1 gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">
                        Send File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreview" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center">
        <div class="relative max-w-4xl max-h-[90vh]">
            <button onclick="closeImagePreview()" 
                    class="absolute top-4 right-4 text-white text-2xl p-2 hover:bg-white/20 rounded-full">
                <i class="fas fa-times"></i>
            </button>
            <img id="previewImage" src="" class="max-w-full max-h-[90vh]">
        </div>
    </div>

    <script>
        // WebRTC variables
        let peerConnection;
        let localStream;
        let remoteStream;
        let isCaller = false;
        let isInCall = false;
        let callStartTime;
        let callTimerInterval;
        
        // Voice recording variables
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer;
        let recordingStartTime;
        
        // File upload variables
        let currentFile = null;
        
        // Chat variables
        let socket = null;
        let currentUser = null;
        let chatUser = null;
        let chatUserId = null;
        let messages = [];
        let typingTimeout = null;
        let isTyping = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await getChatUserIdFromURL();
            await loadCurrentUser();
            await loadChatUser();
            setupSocket();
            loadMessages();
            setupEventListeners();
            checkMediaPermissions();
        });
        
        // Get chat user ID from URL
        function getChatUserIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            chatUserId = urlParams.get('user');
            
            if (!chatUserId) {
                alert('User ID not found in URL');
                window.location.href = '/messages.html';
            }
        }
        
        // Authentication
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': token }
                });
                
                if (!response.ok) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                window.location.href = '/login.html';
            }
        }
        
        // Load current user
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': localStorage.getItem('token') }
                });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }
        
        // Load chat user information
        async function loadChatUser() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/user/${chatUserId}`, {
                    headers: { 'Authorization': token }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    chatUser = data.user;
                    renderChatUserInfo(data.user);
                } else {
                    alert('User not found');
                    window.location.href = '/messages.html';
                }
            } catch (error) {
                console.error('Failed to load chat user:', error);
            }
        }
        
        // Render chat user information
        function renderChatUserInfo(user) {
            document.getElementById('chatUserAvatar').src = user.avatar;
            document.getElementById('chatUserName').textContent = user.nickname;
            document.getElementById('chatUserUniversity').textContent = user.university;
            
            // Update status
            const statusDot = document.getElementById('chatUserStatus');
            statusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
            
            // Update user info sidebar
            document.getElementById('userInfoAvatar').src = user.avatar;
            document.getElementById('userInfoName').textContent = user.nickname;
            document.getElementById('userInfoUsername').textContent = `@${user.username}`;
            document.getElementById('userInfoBio').textContent = user.bio || 'No bio provided';
            document.getElementById('userInfoUniversity').textContent = user.university;
            document.getElementById('userInfoStudyGroup').textContent = user.studyGroup;
            document.getElementById('userInfoPhone').textContent = user.phone;
            document.getElementById('userInfoEmail').textContent = user.email || 'Not provided';
            
            // Status in sidebar
            const statusDiv = document.getElementById('userInfoStatus');
            const statusSpan = statusDiv.querySelector('span');
            statusSpan.className = `w-2 h-2 rounded-full mr-2 ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
            statusDiv.querySelector('span:last-child').textContent = user.isOnline ? 'Online' : 'Offline';
            
            // Account created date
            const createdDate = new Date(user.createdAt);
            document.getElementById('userInfoCreated').textContent = createdDate.toLocaleDateString();
            
            // Update remote user name in call UI
            document.getElementById('remoteUserName').textContent = user.nickname;
            document.getElementById('callerAvatar').src = user.avatar;
            document.getElementById('callerName').textContent = user.nickname;
        }
        
        // Setup Socket.IO
        function setupSocket() {
            const token = localStorage.getItem('token');
            socket = io();
            
            socket.emit('authenticate', token);
            
            // Listen for new messages
            socket.on('newMessage', (message) => {
                if (message.senderId._id === chatUserId || message.senderId === chatUserId) {
                    addMessageToUI(message);
                    markMessageAsRead(message._id);
                }
            });
            
            // Listen for typing indicator
            socket.on('userTyping', (data) => {
                if (data.userId === chatUserId) {
                    showTypingIndicator(data.isTyping);
                }
            });
            
            // Listen for online/offline status
            socket.on('userOnline', (userId) => {
                if (userId === chatUserId) {
                    updateUserStatus(true);
                }
            });
            
            socket.on('userOffline', (userId) => {
                if (userId === chatUserId) {
                    updateUserStatus(false);
                }
            });
            
            // Listen for message read receipts
            socket.on('messageRead', (data) => {
                if (data.senderId === currentUser._id && data.receiverId === chatUserId) {
                    updateMessageReadStatus(data.messageIds);
                }
            });
            
            // WebRTC Signaling
            socket.on('callOffer', async (data) => {
                if (data.from === chatUserId && !isInCall) {
                    showIncomingCall(data);
                }
            });
            
            socket.on('callAnswer', async (data) => {
                if (data.from === chatUserId) {
                    await handleCallAnswer(data);
                }
            });
            
            socket.on('iceCandidate', async (data) => {
                if (data.from === chatUserId) {
                    await handleIceCandidate(data);
                }
            });
            
            socket.on('callEnded', (data) => {
                if (data.from === chatUserId) {
                    endCall();
                    showNotification('Call ended by ' + chatUser.nickname);
                }
            });
            
            socket.on('callRejected', (data) => {
                if (data.from === chatUserId) {
                    hideCallUI();
                    showNotification('Call rejected by ' + chatUser.nickname);
                }
            });
        }
        
        // Check media permissions
        async function checkMediaPermissions() {
            try {
                // Check camera permission
                const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraStream.getTracks().forEach(track => track.stop());
                
                // Check microphone permission
                const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                micStream.getTracks().forEach(track => track.stop());
                
                return true;
            } catch (error) {
                console.warn('Media permissions not granted:', error);
                return false;
            }
        }
        
        // Start video call
        async function startVideoCall() {
            if (!chatUser.isOnline) {
                alert(`${chatUser.nickname} is offline`);
                return;
            }
            
            if (isInCall) {
                alert('You are already in a call');
                return;
            }
            
            try {
                isCaller = true;
                showCallUI('video');
                
                // Get local media stream
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                // Display local video
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
                
                // Create peer connection
                await createPeerConnection();
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Create and send offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send offer to the other user
                socket.emit('callOffer', {
                    to: chatUserId,
                    from: currentUser._id,
                    offer: offer,
                    type: 'video'
                });
                
                // Update call status
                document.getElementById('callStatus').textContent = 'Calling...';
                showNotification('Calling ' + chatUser.nickname + '...');
                
            } catch (error) {
                console.error('Error starting video call:', error);
                endCall();
                alert('Failed to start video call: ' + error.message);
            }
        }
        
        // Start voice call
        async function startVoiceCall() {
            if (!chatUser.isOnline) {
                alert(`${chatUser.nickname} is offline`);
                return;
            }
            
            if (isInCall) {
                alert('You are already in a call');
                return;
            }
            
            try {
                isCaller = true;
                showCallUI('audio');
                
                // Get local audio stream only
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });
                
                // Hide video containers for audio call
                document.querySelectorAll('.video-container').forEach(container => {
                    container.style.display = 'none';
                });
                
                // Create peer connection
                await createPeerConnection();
                
                // Add local audio stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Create and send offer
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Send offer to the other user
                socket.emit('callOffer', {
                    to: chatUserId,
                    from: currentUser._id,
                    offer: offer,
                    type: 'audio'
                });
                
                // Update call status
                document.getElementById('callStatus').textContent = 'Calling...';
                showNotification('Calling ' + chatUser.nickname + '...');
                
            } catch (error) {
                console.error('Error starting voice call:', error);
                endCall();
                alert('Failed to start voice call: ' + error.message);
            }
        }
        
        // Create peer connection
        async function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(configuration);
            
            // Handle remote stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = remoteStream;
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('iceCandidate', {
                        to: chatUserId,
                        from: currentUser._id,
                        candidate: event.candidate
                    });
                }
            };
            
            // Handle connection state
            peerConnection.onconnectionstatechange = () => {
                switch(peerConnection.connectionState) {
                    case 'connected':
                        console.log('WebRTC connection established');
                        startCallTimer();
                        break;
                    case 'disconnected':
                    case 'failed':
                        console.log('WebRTC connection failed');
                        endCall();
                        break;
                    case 'closed':
                        console.log('WebRTC connection closed');
                        break;
                }
            };
        }
        
        // Show incoming call
        function showIncomingCall(data) {
            document.getElementById('callType').textContent = data.type === 'video' ? 'Video Call' : 'Voice Call';
            document.getElementById('incomingCallModal').classList.remove('hidden');
            
            // Auto reject after 30 seconds
            setTimeout(() => {
                if (document.getElementById('incomingCallModal').classList.contains('hidden')) return;
                rejectCall();
            }, 30000);
        }
        
        // Accept call
        async function acceptCall() {
            try {
                document.getElementById('incomingCallModal').classList.add('hidden');
                isCaller = false;
                showCallUI('video'); // Will be adjusted based on call type
                
                // Get local media stream based on call type
                const isVideoCall = document.getElementById('callType').textContent === 'Video Call';
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: isVideoCall,
                    audio: true
                });
                
                // Display local video if video call
                if (isVideoCall) {
                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = localStream;
                } else {
                    // Hide video for audio call
                    document.querySelectorAll('.video-container').forEach(container => {
                        container.style.display = 'none';
                    });
                }
                
                // Create peer connection
                await createPeerConnection();
                
                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Set remote description from offer
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                // Create and send answer
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Send answer to caller
                socket.emit('callAnswer', {
                    to: chatUserId,
                    from: currentUser._id,
                    answer: answer
                });
                
                // Update call status
                document.getElementById('callStatus').textContent = 'In call...';
                showNotification('Call connected with ' + chatUser.nickname);
                
            } catch (error) {
                console.error('Error accepting call:', error);
                endCall();
                alert('Failed to accept call: ' + error.message);
            }
        }
        
        // Reject call
        function rejectCall() {
            document.getElementById('incomingCallModal').classList.add('hidden');
            socket.emit('callRejected', {
                to: chatUserId,
                from: currentUser._id
            });
        }
        
        // Handle call answer
        async function handleCallAnswer(data) {
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                document.getElementById('callStatus').textContent = 'In call...';
                showNotification('Call connected with ' + chatUser.nickname);
            } catch (error) {
                console.error('Error handling call answer:', error);
                endCall();
            }
        }
        
        // Handle ICE candidate
        async function handleIceCandidate(data) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
        
        // Show call UI
        function showCallUI(callType) {
            isInCall = true;
            document.getElementById('callContainer').style.display = 'flex';
            
            // Show/hide video containers based on call type
            if (callType === 'audio') {
                document.querySelectorAll('.video-container').forEach(container => {
                    container.style.display = 'none';
                });
            } else {
                document.querySelectorAll('.video-container').forEach(container => {
                    container.style.display = 'block';
                });
            }
            
            // Update call timer
            callStartTime = Date.now();
            updateCallTimer();
        }
        
        // Hide call UI
        function hideCallUI() {
            document.getElementById('callContainer').style.display = 'none';
            isInCall = false;
            
            // Stop call timer
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            
            // Clean up media streams
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                remoteStream = null;
            }
            
            // Clean up peer connection
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Reset video elements
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            // Show video containers again
            document.querySelectorAll('.video-container').forEach(container => {
                container.style.display = 'block';
            });
            
            // Update call status
            document.getElementById('callStatus').textContent = 'Ready';
        }
        
        // End call
        function endCall() {
            if (isInCall) {
                // Notify other user
                socket.emit('callEnded', {
                    to: chatUserId,
                    from: currentUser._id
                });
                
                // Calculate call duration
                const duration = Date.now() - callStartTime;
                const minutes = Math.floor(duration / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                
                showNotification(`Call ended. Duration: ${minutes}:${seconds.toString().padStart(2, '0')}`);
                
                // Send call duration to chat
                const durationText = `Call duration: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                sendMessage(durationText);
            }
            
            hideCallUI();
        }
        
        // Toggle audio
        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.getElementById('toggleAudioBtn');
                    btn.classList.toggle('active');
                    btn.innerHTML = audioTrack.enabled ? 
                        '<i class="fas fa-microphone"></i>' : 
                        '<i class="fas fa-microphone-slash"></i>';
                }
            }
        }
        
        // Toggle video
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const btn = document.getElementById('toggleVideoBtn');
                    btn.classList.toggle('active');
                    btn.innerHTML = videoTrack.enabled ? 
                        '<i class="fas fa-video"></i>' : 
                        '<i class="fas fa-video-slash"></i>';
                }
            }
        }
        
        // Start call timer
        function startCallTimer() {
            callStartTime = Date.now();
            callTimerInterval = setInterval(updateCallTimer, 1000);
        }
        
        // Update call timer
        function updateCallTimer() {
            if (!callStartTime) return;
            
            const duration = Date.now() - callStartTime;
            const minutes = Math.floor(duration / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            document.getElementById('callTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Voice Recording Functions
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordingStartTime = Date.now();
                
                // Show recording indicator
                document.getElementById('recordingIndicator').classList.remove('hidden');
                updateRecordingTimer();
                recordingTimer = setInterval(updateRecordingTimer, 1000);
                
                // Auto-stop after 2 minutes
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, 120000);
                
            } catch (error) {
                console.error('Error starting voice recording:', error);
                alert('Failed to start voice recording. Please check microphone permissions.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Hide recording indicator
                document.getElementById('recordingIndicator').classList.add('hidden');
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
            }
        }
        
        function updateRecordingTimer() {
            if (!recordingStartTime) return;
            
            const duration = Date.now() - recordingStartTime;
            const minutes = Math.floor(duration / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            document.getElementById('recordingTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        async function sendVoiceMessage(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, `voice_message_${Date.now()}.webm`);
                formData.append('receiverId', chatUserId);
                formData.append('type', 'voice');
                
                const token = localStorage.getItem('token');
                const response = await fetch('/api/messages/voice', {
                    method: 'POST',
                    headers: {
                        'Authorization': token
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessageToUI(data.message);
                }
            } catch (error) {
                console.error('Error sending voice message:', error);
                alert('Failed to send voice message');
            }
        }
        
        // File Attachment Functions
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '*/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    previewFile(file);
                }
            };
            input.click();
        }
        
        function previewFile(file) {
            currentFile = file;
            
            const previewDiv = document.getElementById('filePreview');
            const fileSize = formatFileSize(file.size);
            const fileIcon = getFileIcon(file.type);
            
            previewDiv.innerHTML = `
                <div class="file-preview">
                    <div class="file-icon">
                        <i class="${fileIcon}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                        <div class="progress-bar">
                            <div class="progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('fileUploadModal').classList.remove('hidden');
        }
        
        function closeFileUploadModal() {
            document.getElementById('fileUploadModal').classList.add('hidden');
            currentFile = null;
        }
        
        async function sendFile() {
            if (!currentFile) return;
            
            try {
                const formData = new FormData();
                formData.append('file', currentFile);
                formData.append('receiverId', chatUserId);
                formData.append('type', 'file');
                
                const token = localStorage.getItem('token');
                const response = await fetch('/api/messages/file', {
                    method: 'POST',
                    headers: {
                        'Authorization': token
                    },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessageToUI(data.message);
                    closeFileUploadModal();
                }
            } catch (error) {
                console.error('Error sending file:', error);
                alert('Failed to send file');
            }
        }
        
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'fas fa-image';
            if (mimeType.startsWith('video/')) return 'fas fa-video';
            if (mimeType.startsWith('audio/')) return 'fas fa-music';
            if (mimeType.includes('pdf')) return 'fas fa-file-pdf';
            if (mimeType.includes('word')) return 'fas fa-file-word';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'fas fa-file-excel';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'fas fa-file-powerpoint';
            if (mimeType.includes('zip') || mimeType.includes('compressed')) return 'fas fa-file-archive';
            return 'fas fa-file';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Location sharing
        function attachLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const locationText = `üìç My location: https://maps.google.com/?q=${latitude},${longitude}`;
                        sendMessage(locationText);
                    },
                    (error) => {
                        alert('Unable to get location: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        }
        
        // Rest of the chat functions (loadMessages, renderMessages, sendMessage, etc.)
        // These remain the same as before but enhanced for voice messages and files
        
        // Load messages
        async function loadMessages() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/messages/${chatUserId}`, {
                    headers: { 'Authorization': token }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messages = data.messages;
                    renderMessages(data.messages);
                    
                    // Scroll to bottom
                    setTimeout(() => {
                        const container = document.getElementById('messagesContainer');
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }
        
        // Render messages with support for voice messages
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            
            if (!messages || messages.length === 0) {
                return;
            }
            
            // Group messages by date
            const groupedMessages = groupMessagesByDate(messages);
            
            container.innerHTML = '';
            
            Object.keys(groupedMessages).forEach(date => {
                // Add date separator
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'text-center my-4';
                dateSeparator.innerHTML = `
                    <span class="inline-block bg-gray-100 text-gray-600 text-xs px-3 py-1 rounded-full">
                        ${formatDate(date)}
                    </span>
                `;
                container.appendChild(dateSeparator);
                
                // Add messages for this date
                groupedMessages[date].forEach(msg => {
                    const messageDiv = createMessageElement(msg);
                    container.appendChild(messageDiv);
                });
            });
        }
        
        // Create message element with voice message support
        function createMessageElement(msg) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${msg.senderId._id === currentUser._id ? 'justify-end' : 'justify-start'}`;
            
            const isCurrentUser = msg.senderId._id === currentUser._id;
            const sender = isCurrentUser ? currentUser : chatUser;
            
            let contentHtml = '';
            
            if (msg.mediaType === 'voice') {
                contentHtml = `
                    <div class="voice-message">
                        <button onclick="playVoiceMessage('${msg.mediaUrl}')" class="mr-3">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="voice-wave">
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                            <div class="voice-bar"></div>
                        </div>
                        <span class="ml-3 text-xs">${msg.duration || '0:00'}</span>
                    </div>
                `;
            } else if (msg.mediaType === 'file') {
                const fileName = msg.mediaMetadata?.fileName || 'File';
                const fileSize = msg.mediaMetadata?.fileSize ? formatFileSize(msg.mediaMetadata.fileSize) : '';
                const fileIcon = getFileIcon(msg.mediaMetadata?.mimeType || '');
                
                contentHtml = `
                    <div class="file-preview">
                        <div class="file-icon">
                            <i class="${fileIcon}"></i>
                        </div>
                        <div class="file-info">
                            <div class="file-name">${fileName}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                        <a href="${msg.mediaUrl}" download="${fileName}" class="ml-2">
                            <i class="fas fa-download text-gray-600"></i>
                        </a>
                    </div>
                `;
            } else if (msg.mediaUrl) {
                contentHtml = `
                    <div class="mb-2">
                        ${msg.mediaType === 'image' ? 
                            `<img src="${msg.mediaUrl}" class="max-w-full rounded-lg cursor-pointer" 
                                 style="max-height: 300px;" onclick="viewImage('${msg.mediaUrl}')">` :
                            msg.mediaType === 'video' ?
                            `<video src="${msg.mediaUrl}" controls class="max-w-full rounded-lg" style="max-height: 300px;"></video>` :
                            `<div class="flex items-center p-3 bg-gray-100 rounded-lg">
                                <i class="fas fa-file text-gray-600 text-xl mr-3"></i>
                                <div>
                                    <p class="font-medium">File Attachment</p>
                                    <p class="text-sm text-gray-500">Click to download</p>
                                </div>
                            </div>`
                        }
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble ${isCurrentUser ? 'sent' : 'received'} p-3">
                    ${!isCurrentUser ? `
                        <div class="flex items-center mb-1">
                            <span class="font-medium text-sm">${sender.nickname}</span>
                        </div>
                    ` : ''}
                    
                    ${contentHtml}
                    
                    ${msg.text ? `<p class="${msg.mediaUrl ? 'mt-2' : ''}">${formatMessageText(msg.text)}</p>` : ''}
                    
                    <div class="flex items-center justify-end mt-2 space-x-2">
                        <span class="text-xs opacity-70 ${isCurrentUser ? 'text-white/70' : 'text-gray-500'}">
                            ${formatTime(msg.createdAt)}
                        </span>
                        ${isCurrentUser ? `
                            <span class="text-xs ${msg.isRead ? 'text-white/70' : 'text-white/50'}">
                                ${msg.isRead ? '<i class="fas fa-check-double"></i>' : '<i class="fas fa-check"></i>'}
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return messageDiv;
        }
        
        // Play voice message
        function playVoiceMessage(url) {
            const audio = new Audio(url);
            audio.play();
        }
        
        // Send message
        async function sendMessage(text) {
            const input = document.getElementById('messageInput');
            const messageText = text || input.value.trim();
            
            if (!messageText) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        receiverId: chatUserId,
                        text: messageText
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    if (!text) input.value = '';
                    autoResize(input);
                    addMessageToUI(data.message);
                    
                    // Stop typing indicator
                    if (socket && isTyping) {
                        socket.emit('typing', {
                            userId: chatUserId,
                            isTyping: false
                        });
                        isTyping = false;
                    }
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }
        
        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Setup event listeners for call
        function setupEventListeners() {
            // Close modals when clicking outside
            document.addEventListener('click', (event) => {
                const emojiPicker = document.getElementById('emojiPicker');
                const emojiBtn = document.querySelector('[onclick="sendEmoji()"]');
                
                if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
                    emojiPicker.classList.add('hidden');
                }
                
                const fileModal = document.getElementById('fileUploadModal');
                if (fileModal && !fileModal.contains(event.target) && !event.target.closest('[onclick="attachFile()"]')) {
                    if (!fileModal.classList.contains('hidden')) {
                        closeFileUploadModal();
                    }
                }
            });
            
            // Handle escape key to end call
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && isInCall) {
                    endCall();
                }
            });
        }
        
        // Helper functions (formatDate, formatTime, etc.) remain the same
        
        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
        }
        
        // Format time
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Group messages by date
        function groupMessagesByDate(messages) {
            const groups = {};
            
            messages.forEach(msg => {
                const date = new Date(msg.createdAt).toDateString();
                if (!groups[date]) {
                    groups[date] = [];
                }
                groups[date].push(msg);
            });
            
            return groups;
        }
        
        // Format message text
        function formatMessageText(text) {
            // Convert URLs to links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, url => `<a href="${url}" target="_blank" class="text-blue-400 hover:underline">${url}</a>`);
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
        
        // Handle key down events
        function handleKeyDown(event) {
            // Send on Enter (without Shift)
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
                return;
            }
            
            // Typing indicator
            if (socket && chatUserId) {
                if (!isTyping) {
                    socket.emit('typing', {
                        userId: chatUserId,
                        isTyping: true
                    });
                    isTyping = true;
                }
                
                // Clear previous timeout
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // Set timeout to stop typing indicator after 2 seconds
                typingTimeout = setTimeout(() => {
                    if (isTyping) {
                        socket.emit('typing', {
                            userId: chatUserId,
                            isTyping: false
                        });
                        isTyping = false;
                    }
                }, 2000);
            }
        }
        
        // Send quick message
        function sendQuickMessage(text) {
            const input = document.getElementById('messageInput');
            input.value = text;
            autoResize(input);
            sendMessage();
        }
        
        // Show typing indicator
        function showTypingIndicator(isTyping) {
            const indicator = document.getElementById('typingIndicator');
            const text = document.getElementById('typingText');
            
            if (isTyping) {
                text.textContent = `${chatUser.nickname} is typing...`;
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }
        
        // Update user status
        function updateUserStatus(isOnline) {
            if (chatUser) {
                chatUser.isOnline = isOnline;
                
                // Update status dot
                const statusDot = document.getElementById('chatUserStatus');
                statusDot.className = `w-3 h-3 rounded-full absolute bottom-0 right-0 border-2 border-white ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                
                // Update sidebar status
                const statusDiv = document.getElementById('userInfoStatus');
                const statusSpan = statusDiv.querySelector('span');
                statusSpan.className = `w-2 h-2 rounded-full mr-2 ${isOnline ? 'bg-green-500' : 'bg-gray-400'}`;
                statusDiv.querySelector('span:last-child').textContent = isOnline ? 'Online' : 'Offline';
            }
        }
        
        // Other existing functions remain the same
        // (toggleUserInfo, openMediaGallery, viewImage, closeImagePreview, etc.)
        
        function toggleUserInfo() {
            const sidebar = document.getElementById('userInfoSidebar');
            sidebar.classList.toggle('hidden');
        }
        
        function openMediaGallery() {
            // Implementation remains the same
        }
        
        function viewImage(url) {
            document.getElementById('previewImage').src = url;
            document.getElementById('imagePreview').classList.remove('hidden');
        }
        
        function closeImagePreview() {
            document.getElementById('imagePreview').classList.add('hidden');
        }
        
        function sendEmoji() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('hidden');
        }
        
        function closeEmojiPicker() {
            document.getElementById('emojiPicker').classList.add('hidden');
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            autoResize(input);
            closeEmojiPicker();
        }
        
        function attachImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Upload image
                }
            };
            input.click();
        }
        
        function viewFullProfile() {
            window.location.href = `/profile.html?user=${chatUserId}`;
        }
        
        async function blockUser() {
            if (!confirm(`Are you sure you want to block ${chatUser.nickname}?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/users/${chatUserId}/block`, {
                    method: 'POST',
                    headers: { 'Authorization': token }
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('User blocked successfully');
                    window.location.href = '/messages.html';
                }
            } catch (error) {
                console.error('Failed to block user:', error);
                alert('Failed to block user');
            }
        }
        
        function logout() {
            // End call if active
            if (isInCall) {
                endCall();
            }
            
            // Logout implementation
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>