<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil — SChat</title>

  <script>
    tailwind = { config: { darkMode:'class', theme:{ extend:{
      fontFamily:{ inter:['Inter','ui-sans-serif','system-ui'] },
      keyframes:{
        floaty:{'0%,100%':{transform:'translateY(0px)'},'50%':{transform:'translateY(-7px)'}},
        shimmer:{'0%':{backgroundPosition:'0% 50%'},'100%':{backgroundPosition:'100% 50%'}},
        pop:{'0%':{transform:'scale(.98)',opacity:.0},'100%':{transform:'scale(1)',opacity:1}}
      },
      animation:{ floaty:'floaty 7s ease-in-out infinite', shimmer:'shimmer 8s ease-in-out infinite', pop:'pop .45s ease-out both' }
    }}}};
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --glass-bg: rgba(255,255,255,.58);
      --glass-brd: rgba(255,255,255,.34);
      --muted: rgba(15,23,42,.72);
      --muted2: rgba(15,23,42,.55);
      --grid: rgba(15,23,42,.06);
      --ring: rgba(99,102,241,.40);
      --shadow: rgba(0,0,0,.18);
    }
    .dark{
      --glass-bg: rgba(2,6,23,.58);
      --glass-brd: rgba(148,163,184,.16);
      --muted: rgba(226,232,240,.80);
      --muted2: rgba(226,232,240,.55);
      --grid: rgba(148,163,184,.08);
      --ring: rgba(236,72,153,.30);
      --shadow: rgba(0,0,0,.44);
    }
    body{ font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted2); }
    .glass{
      background: var(--glass-bg);
      border: 1px solid var(--glass-brd);
      box-shadow: 0 22px 70px var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .glow:focus{ outline:none; box-shadow: 0 0 0 5px var(--ring); }
    .u-anim{
      background: linear-gradient(90deg, rgba(99,102,241,1), rgba(236,72,153,1), rgba(34,197,94,1));
      background-size: 200% 200%;
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: shimmer 8s ease-in-out infinite;
    }
    .bg-orbs{
      position: fixed; inset: 0; z-index: -2; overflow:hidden;
      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(99,102,241,.38), transparent 60%),
        radial-gradient(900px 520px at 88% 18%, rgba(236,72,153,.28), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(34,197,94,.22), transparent 60%),
        linear-gradient(180deg, rgba(248,250,252,1), rgba(241,245,249,1));
    }
    .dark .bg-orbs{
      background:
        radial-gradient(1200px 600px at 12% 12%, rgba(99,102,241,.24), transparent 60%),
        radial-gradient(900px 520px at 88% 18%, rgba(236,72,153,.20), transparent 60%),
        radial-gradient(1000px 700px at 50% 92%, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,1), rgba(15,23,42,1));
    }
    .bg-grid{
      position: fixed; inset: 0; z-index: -1; pointer-events:none;
      background-image: linear-gradient(to right, var(--grid) 1px, transparent 1px),
                        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: 70px 70px;
      mask-image: radial-gradient(closest-side at 50% 35%, black 0%, transparent 70%);
      opacity: .85;
    }
    .btn-primary{
      background: linear-gradient(135deg, rgba(99,102,241,1), rgba(236,72,153,1));
    }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-ghost:hover{ background: rgba(148,163,184,.12); }
    .field{
      background: rgba(255,255,255,.36);
      border: 1px solid rgba(255,255,255,.28);
    }
    .dark .field{
      background: rgba(2,6,23,.32);
      border: 1px solid rgba(148,163,184,.18);
    }
    .field:focus{ outline:none; box-shadow: 0 0 0 5px var(--ring); border-color: transparent; }

    /* Robot */
    .robot-shadow{ filter: drop-shadow(0 16px 24px rgba(0,0,0,.22)); }
  </style>

  <script>
    (function(){
      const key='theme';
      const saved=localStorage.getItem(key);
      const prefers=window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode=saved || (prefers?'dark':'light');
      if(mode==='dark') document.documentElement.classList.add('dark');
    })();
  </script>
</head>

<body class="min-h-screen text-slate-900 dark:text-slate-100">
  <div class="bg-orbs"></div>
  <div class="bg-grid"></div>

  <header class="sticky top-0 z-50">
    <div class="mx-auto max-w-6xl px-4 py-4">
      <div class="glass rounded-3xl px-4 py-3 flex items-center justify-between">
        <a href="/messages.html" class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl btn-primary flex items-center justify-center text-white">
            <i class="fa-solid fa-user-astronaut"></i>
          </div>
          <div class="leading-tight">
            <div class="font-extrabold tracking-tight">Profil</div>
            <div class="text-xs muted">Robotcha • Kolleksiya • Do‘stlar</div>
          </div>
        </a>

        <div class="flex items-center gap-2">
          <button id="themeToggle" class="glass rounded-xl px-3 py-2 text-sm font-extrabold btn-ghost glow">
            <i id="themeIcon" class="fa-solid fa-moon"></i>
            <span class="ml-2 hidden sm:inline" id="themeLabel">Tungi</span>
          </button>
          <button id="shareBtn" class="glass rounded-xl px-3 py-2 text-sm font-extrabold btn-ghost glow">
            <i class="fa-solid fa-link"></i><span class="ml-2 hidden sm:inline">Ulashish</span>
          </button>
          <button id="logoutBtn" class="glass rounded-xl px-3 py-2 text-sm font-extrabold btn-ghost glow">
            <i class="fa-solid fa-right-from-bracket"></i><span class="ml-2 hidden sm:inline">Chiqish</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8">
    <!-- Profile Card -->
    <section class="glass rounded-3xl overflow-hidden animate-pop">
      <div class="relative h-44 sm:h-56" id="cover" style="background: linear-gradient(135deg, rgba(99,102,241,.92), rgba(236,72,153,.86));">
        <div class="absolute inset-0 opacity-25" style="background-image: radial-gradient(circle at 20% 30%, rgba(255,255,255,.55), transparent 45%), radial-gradient(circle at 80% 40%, rgba(255,255,255,.40), transparent 45%);"></div>
        <div class="absolute bottom-4 left-4 right-4 flex items-end justify-between gap-3">
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 sm:w-24 sm:h-24 rounded-3xl overflow-hidden ring-4 ring-white/20 shadow-xl bg-white/10">
              <img id="avatar" class="w-full h-full object-cover" alt="avatar"/>
            </div>
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <h1 id="name" class="text-2xl sm:text-3xl font-black tracking-tight text-white truncate">Yuklanmoqda…</h1>
                <span id="verified" class="hidden inline-flex items-center gap-2 text-xs font-extrabold px-3 py-1 rounded-full bg-white/20 text-white">
                  <i class="fa-solid fa-badge-check"></i> Tasdiqlangan
                </span>
              </div>
              <div class="text-sm text-white/80 font-semibold truncate">@<span id="username">…</span></div>
              <div class="mt-2 flex flex-wrap gap-2">
                <span class="inline-flex items-center gap-2 text-xs font-extrabold px-3 py-1 rounded-full bg-white/15 text-white">
                  <i class="fa-solid fa-building-columns"></i><span id="university">—</span>
                </span>
                <span class="inline-flex items-center gap-2 text-xs font-extrabold px-3 py-1 rounded-full bg-white/15 text-white">
                  <i class="fa-solid fa-users"></i><span id="studyGroup">—</span>
                </span>
                <span class="inline-flex items-center gap-2 text-xs font-extrabold px-3 py-1 rounded-full bg-white/15 text-white">
                  <span id="onlineDot" class="w-2 h-2 rounded-full bg-white/70"></span><span id="onlineText">—</span>
                </span>
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="messageBtn" class="hidden btn-primary text-white rounded-2xl px-4 py-3 text-sm font-extrabold glow">
              <i class="fa-solid fa-comment-dots mr-2"></i>Xabar yozish
            </button>
            <button id="editBtn" class="hidden glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow">
              <i class="fa-solid fa-pen mr-2"></i>Tahrirlash
            </button>
          </div>
        </div>
      </div>

      <div class="p-6">
        <div class="grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2">
            <div class="text-sm font-extrabold muted">Bio</div>
            <p id="bio" class="mt-2 muted2 leading-relaxed">—</p>

            <!-- Edit form (only self) -->
            <div id="editPanel" class="hidden mt-5 glass rounded-3xl p-5">
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <div class="text-xs font-extrabold muted">To‘liq ism</div>
                  <input id="fullNameIn" class="field w-full rounded-2xl px-4 py-3 text-sm mt-2" placeholder="To‘liq ism" />
                </div>
                <div>
                  <div class="text-xs font-extrabold muted">Nickname</div>
                  <input id="nicknameIn" class="field w-full rounded-2xl px-4 py-3 text-sm mt-2" placeholder="Nickname" />
                </div>
                <div>
                  <div class="text-xs font-extrabold muted">Username</div>
                  <input id="usernameIn" class="field w-full rounded-2xl px-4 py-3 text-sm mt-2" placeholder="username" />
                  <div class="text-[11px] muted2 mt-1">Username 15 kunda 1 marta o‘zgaradi.</div>
                </div>
                <div>
                  <div class="text-xs font-extrabold muted">Telefon</div>
                  <input id="phoneIn" class="field w-full rounded-2xl px-4 py-3 text-sm mt-2" placeholder="+998…" />
                </div>
                <div class="sm:col-span-2">
                  <div class="text-xs font-extrabold muted">Bio</div>
                  <textarea id="bioIn" class="field w-full rounded-2xl px-4 py-3 text-sm mt-2" rows="3" placeholder="O‘zingiz haqingizda..."></textarea>
                </div>
              </div>

              <div class="mt-4 flex flex-wrap gap-2">
                <button id="saveProfileBtn" class="btn-primary text-white rounded-2xl px-5 py-3 text-sm font-extrabold glow">
                  <i class="fa-solid fa-floppy-disk mr-2"></i>Saqlash
                </button>
                <button id="cancelEditBtn" class="glass rounded-2xl px-5 py-3 text-sm font-extrabold btn-ghost glow">
                  Bekor qilish
                </button>
              </div>
            </div>
          </div>

          <!-- Robot panel -->
          <div class="glass rounded-3xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="font-black text-lg">Robotcha</div>
                <div class="text-xs muted2">Active robot va holat</div>
              </div>
              <div class="text-xs font-extrabold muted">
                <i class="fa-solid fa-coins mr-1"></i><span id="coins">—</span>
              </div>
            </div>

            <div class="mt-4 flex items-center justify-center">
              <svg id="robotSvg" class="robot-shadow w-44 h-44" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" aria-label="robot">
                <defs>
                  <linearGradient id="rbG" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="#6366f1"/>
                    <stop offset="1" stop-color="#ec4899"/>
                  </linearGradient>
                </defs>

                <rect x="38" y="40" width="104" height="100" rx="26" fill="url(#rbG)" opacity="0.96"/>
                <rect x="52" y="58" width="76" height="44" rx="18" fill="rgba(255,255,255,0.18)"/>

                <circle id="eyeL" cx="74" cy="80" r="8" fill="white"/>
                <circle id="eyeR" cx="106" cy="80" r="8" fill="white"/>
                <circle id="pupilL" cx="74" cy="80" r="3.2" fill="rgba(15,23,42,0.85)"/>
                <circle id="pupilR" cx="106" cy="80" r="3.2" fill="rgba(15,23,42,0.85)"/>

                <path id="mouth" d="M70 110 Q90 124 110 110" stroke="rgba(255,255,255,0.92)" stroke-width="6" fill="none" stroke-linecap="round"/>

                <rect x="84" y="20" width="12" height="14" rx="6" fill="rgba(255,255,255,0.45)"/>
                <circle cx="90" cy="18" r="8" fill="rgba(255,255,255,0.65)"/>
              </svg>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
              <div class="glass rounded-2xl px-3 py-2">
                <div class="muted2 font-extrabold">Yoqimtoylik</div>
                <div class="font-black text-base"><span id="cuteness">—</span>/100</div>
              </div>
              <div class="glass rounded-2xl px-3 py-2">
                <div class="muted2 font-extrabold">Level</div>
                <div class="font-black text-base">Lv <span id="level">—</span></div>
              </div>
              <div class="glass rounded-2xl px-3 py-2">
                <div class="muted2 font-extrabold">Mood</div>
                <div class="font-black text-base" id="mood">—</div>
              </div>
              <div class="glass rounded-2xl px-3 py-2">
                <div class="muted2 font-extrabold">Outfit</div>
                <div class="font-black text-base" id="outfit">—</div>
              </div>
            </div>

            <div id="selfRobotActions" class="mt-4 hidden">
              <div class="flex flex-wrap gap-2">
                <button id="openRobotShopBtn" class="btn-primary text-white rounded-2xl px-4 py-3 text-sm font-extrabold glow">
                  <i class="fa-solid fa-store mr-2"></i>Robot do‘koni
                </button>
                <button id="openUpgradeBtn" class="glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow">
                  <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Upgrade
                </button>
                <a href="/petmarket.html" class="glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow">
                  <i class="fa-solid fa-bag-shopping mr-2"></i>Pet Market
                </a>
              </div>
            </div>

            <div id="otherPlayActions" class="mt-4 hidden">
              <div class="text-xs font-extrabold muted mb-2">O‘ynash</div>
              <div class="flex flex-wrap gap-2">
                <button data-play="wave" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow"><i class="fa-solid fa-hand mr-2"></i>Salom</button>
                <button data-play="highfive" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow"><i class="fa-solid fa-handshake mr-2"></i>High‑five</button>
                <button data-play="boop" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow"><i class="fa-solid fa-fingerprint mr-2"></i>Boop</button>
                <button data-play="tickle" class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow"><i class="fa-solid fa-feather-pointed mr-2"></i>Qitiqlash</button>
              </div>
              <div class="text-[11px] muted2 mt-2">Reaksiya robotchaning yoqimtoyligiga bog‘liq.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Robot Collection -->
    <section class="mt-6 glass rounded-3xl p-6 animate-pop">
      <div class="flex items-end justify-between gap-3 flex-wrap">
        <div>
          <div class="text-xl font-black">Robotlar kolleksiyasi</div>
          <div class="text-sm muted2 mt-1">Har xil turdagi robotchalar — ko‘rish, tanlash va o‘ynash.</div>
        </div>
        <div class="flex gap-2">
          <button id="refreshRobotsBtn" class="glass rounded-2xl px-4 py-3 text-sm font-extrabold btn-ghost glow">
            <i class="fa-solid fa-rotate mr-2"></i>Yangilash
          </button>
        </div>
      </div>

      <div id="robotGrid" class="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="robotEmpty" class="hidden mt-6 text-sm muted2">Kolleksiya bo‘sh.</div>
    </section>

    <div id="toast" class="hidden fixed top-6 left-1/2 -translate-x-1/2 z-[60] glass rounded-2xl px-4 py-3 text-sm font-extrabold"></div>

    <!-- Robot Shop Modal -->
    <div id="robotShopModal" class="hidden fixed inset-0 z-[70]">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto max-w-4xl px-4 py-8">
        <div class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-black">Robot do‘koni</div>
              <div class="text-sm muted2 mt-1">Yangi robot sotib oling. Yoqimtoylik va rarity farqli bo‘ladi.</div>
            </div>
            <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow" onclick="closeModal('robotShopModal')">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div id="robotCatalog" class="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
      </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="hidden fixed inset-0 z-[70]">
      <div class="absolute inset-0 bg-black/60"></div>
      <div class="relative mx-auto max-w-3xl px-4 py-8">
        <div class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xl font-black">Upgrade</div>
              <div class="text-sm muted2 mt-1">Tanlangan robotni kuchaytirish (coins).</div>
            </div>
            <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow" onclick="closeModal('upgradeModal')">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="mt-4 glass rounded-3xl p-4">
            <div class="text-sm font-extrabold muted">Tanlangan robot:</div>
            <div class="mt-1 font-black text-lg" id="upgradeTargetName">—</div>
          </div>

          <div id="upgradeList" class="mt-4 grid sm:grid-cols-2 gap-3"></div>
        </div>
      </div>
    </div>

  </main>

  <script>
    // Theme toggle
    (function(){
      const key='theme';
      const html=document.documentElement;
      const btn=document.getElementById('themeToggle');
      const icon=document.getElementById('themeIcon');
      const label=document.getElementById('themeLabel');
      function apply(mode){
        if(mode==='dark') html.classList.add('dark'); else html.classList.remove('dark');
        localStorage.setItem(key, mode);
        icon.className = mode==='dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        label.textContent = mode==='dark' ? 'Kunduzgi' : 'Tungi';
      }
      const saved=localStorage.getItem(key);
      apply(saved || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light'));
      btn.addEventListener('click', ()=> apply(html.classList.contains('dark') ? 'light' : 'dark'));
    })();

    const toast = (msg, type='ok') => {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.background = type==='error' ? 'rgba(239,68,68,.14)' : 'rgba(34,197,94,.14)';
      el.style.color = type==='error' ? 'rgba(220,38,38,.95)' : 'rgba(16,185,129,.95)';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.add('hidden'), 3500);
    };

    const token = () => localStorage.getItem('token') || '';
    const authHeaders = () => ({ 'Authorization': 'Bearer ' + token(), 'Content-Type': 'application/json' });

    const qs = new URLSearchParams(location.search);
    const viewUserId = qs.get('user');        // profile.html?user=<id>
    const viewUsername = qs.get('u');         // profile.html?u=<username>

    let me = null;
    let viewed = null;
    let catalog = null;
    let upgrades = null;
    let selectedRobotId = null;

    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
    function openModal(id){ document.getElementById(id).classList.remove('hidden'); }

    // Tiny sound engine (no mp3) - different tones per mood
    function playMoodSound(mood){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        const map = {
          happy: 520,
          neutral: 420,
          thinking: 320,
          sad: 220
        };
        o.type = 'sine';
        o.frequency.value = map[mood] || 380;
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.18, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
        o.start();
        o.stop(ctx.currentTime + 0.2);
        setTimeout(()=>ctx.close(), 450);
      }catch(e){}
    }

    function setRobotMood(mood){
      const mouth = document.getElementById('mouth');
      const moodEl = document.getElementById('mood');
      moodEl.textContent = mood || 'neutral';
      if(mood === 'happy') mouth.setAttribute('d','M70 108 Q90 130 110 108');
      else if(mood === 'sad') mouth.setAttribute('d','M70 126 Q90 104 110 126');
      else if(mood === 'thinking') mouth.setAttribute('d','M72 118 Q90 118 108 118');
      else mouth.setAttribute('d','M70 110 Q90 124 110 110');
      playMoodSound(mood || 'neutral');
    }

    function setRobotColors(baseColor, outfitColor){
      const svg = document.getElementById('robotSvg');
      const stops = svg.querySelectorAll('stop');
      if(stops.length >= 2){
        stops[0].setAttribute('stop-color', baseColor || '#6366f1');
        stops[1].setAttribute('stop-color', outfitColor || '#ec4899');
      }
    }

    function rarityBadge(r){
      const map = { common:'Oddiy', rare:'Noyob', epic:'Epik', legend:'Legend' };
      return map[r] || r || '—';
    }

    async function apiGet(url){
      const r = await fetch(url, { headers: authHeaders() });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(j.error || j.message || 'Xatolik');
      return j;
    }
    async function apiPost(url, body){
      const r = await fetch(url, { method:'POST', headers: authHeaders(), body: JSON.stringify(body||{}) });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(j.error || j.message || 'Xatolik');
      return j;
    }
    async function apiPut(url, body){
      const r = await fetch(url, { method:'PUT', headers: authHeaders(), body: JSON.stringify(body||{}) });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(j.error || j.message || 'Xatolik');
      return j;
    }

    async function loadMe(){
      const r = await apiGet('/api/me');
      if(!r.success) throw new Error('Auth failed');
      me = r.user;
      return me;
    }

    async function loadViewed(){
      if(viewUserId){
        const r = await apiGet('/api/user/' + encodeURIComponent(viewUserId));
        viewed = r.user;
      } else if(viewUsername){
        const r = await apiGet('/api/user/by-username/' + encodeURIComponent(viewUsername));
        viewed = r.user;
      } else {
        viewed = me; // own
      }
      return viewed;
    }

    async function loadCatalog(){
      const r = await apiGet('/api/robots/catalog');
      catalog = r.catalog || [];
      upgrades = r.upgrades || {};
    }

    function fillProfile(u){
      // cover
      const cover = document.getElementById('cover');
      if(u.coverBanner){
        cover.style.backgroundImage = `url('${u.coverBanner}')`;
        cover.style.backgroundSize = 'cover';
        cover.style.backgroundPosition = 'center';
      }

      document.getElementById('avatar').src = u.avatar || 'https://res.cloudinary.com/demo/image/upload/v1692290000/default-avatar.png';
      document.getElementById('name').textContent = (u.fullName || u.nickname || u.username || 'Foydalanuvchi');
      document.getElementById('username').textContent = u.username || '';
      document.getElementById('university').textContent = u.university || '—';
      document.getElementById('studyGroup').textContent = u.studyGroup || '—';
      document.getElementById('bio').textContent = u.bio || 'Bio yo‘q.';

      if(u.verified){
        document.getElementById('verified').classList.remove('hidden');
      }

      const online = !!u.isOnline;
      document.getElementById('onlineDot').className = 'w-2 h-2 rounded-full ' + (online ? 'bg-emerald-300' : 'bg-white/60');
      document.getElementById('onlineText').textContent = online ? 'Online' : 'Offline';

      // robot info
      const a = u.activeRobot || (u.robots && u.robots.find(x=>x.equipped)) || (u.robots && u.robots[0]) || null;
      if(a){
        setRobotColors(a.baseColor, a.outfitColor);
        document.getElementById('cuteness').textContent = a.cuteness ?? '—';
        document.getElementById('level').textContent = a.level ?? '—';
        document.getElementById('outfit').textContent = a.typeId || '—';
        setRobotMood(a.mood || 'neutral');
      } else {
        setRobotColors('#6366f1','#ec4899');
        document.getElementById('cuteness').textContent = '—';
        document.getElementById('level').textContent = '—';
        document.getElementById('outfit').textContent = '—';
        setRobotMood('neutral');
      }
    }

    function renderRobotGrid(u){
      const grid = document.getElementById('robotGrid');
      const empty = document.getElementById('robotEmpty');
      grid.innerHTML = '';

      const robots = (u.robots || []);
      if(!robots.length){
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      robots.forEach(r=>{
        const meta = (catalog||[]).find(x=>x.id === r.typeId) || {};
        const card = document.createElement('div');
        card.className = 'glass rounded-3xl p-4';
        const equipped = !!r.equipped || (String(u.activeRobotId) === String(r._id));
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-black truncate">${r.name || meta.name || 'Robot'}</div>
              <div class="text-xs muted2 mt-1">${meta.desc || ''}</div>
            </div>
            <div class="text-[11px] font-extrabold px-3 py-1 rounded-full ${equipped ? 'bg-emerald-500/15 text-emerald-200 dark:text-emerald-200' : 'bg-slate-500/10 muted'}">
              ${equipped ? 'Active' : rarityBadge(meta.rarity)}
            </div>
          </div>

          <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Cute</div>
              <div class="font-black">${r.cuteness ?? 0}/100</div>
            </div>
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Lv</div>
              <div class="font-black">${r.level ?? 1}</div>
            </div>
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Mood</div>
              <div class="font-black">${r.mood || 'neutral'}</div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1 rounded-full glass">
              <i class="fa-solid fa-palette muted2"></i><span class="muted2">${r.baseColor || ''}</span>
            </span>
            <span class="inline-flex items-center gap-2 text-[11px] font-extrabold px-3 py-1 rounded-full glass">
              <i class="fa-solid fa-shirt muted2"></i><span class="muted2">${r.outfitColor || ''}</span>
            </span>
          </div>

          <div class="mt-4 flex flex-wrap gap-2">
            ${isSelf() ? `
              <button class="btn-primary text-white rounded-2xl px-4 py-2 text-sm font-extrabold glow" data-equip="${r._id}">
                <i class="fa-solid fa-check mr-2"></i>Tanlash
              </button>
              <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow" data-upgrade="${r._id}" data-name="${(r.name||meta.name||'Robot').replaceAll('"','&quot;')}">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Upgrade
              </button>
            ` : `
              <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow" data-play="wave">
                <i class="fa-solid fa-hand mr-2"></i>Salom
              </button>
              <button class="glass rounded-2xl px-4 py-2 text-sm font-extrabold btn-ghost glow" data-play="boop">
                <i class="fa-solid fa-fingerprint mr-2"></i>Boop
              </button>
            `}
          </div>
        `;
        grid.appendChild(card);
      });

      // bind actions
      grid.querySelectorAll('[data-equip]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          try{
            const id = btn.getAttribute('data-equip');
            await apiPost('/api/robots/equip', { robotId: id });
            toast('Active robot tanlandi');
            await reloadAll();
          }catch(e){ toast(e.message, 'error'); }
        });
      });
      grid.querySelectorAll('[data-upgrade]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          selectedRobotId = btn.getAttribute('data-upgrade');
          document.getElementById('upgradeTargetName').textContent = btn.getAttribute('data-name') || 'Robot';
          renderUpgradeList();
          openModal('upgradeModal');
        });
      });
      grid.querySelectorAll('[data-play]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          try{
            if(!viewed || isSelf()) return;
            const action = btn.getAttribute('data-play');
            const r = await apiPost('/api/robots/play', { targetUserId: viewed._id, action });
            toast(r.message || 'O‘ynaldi');
            setRobotMood(r.reaction || 'neutral');
          }catch(e){ toast(e.message, 'error'); }
        });
      });
    }

    function renderShop(){
      const box = document.getElementById('robotCatalog');
      box.innerHTML = '';
      (catalog||[]).forEach(item=>{
        const owned = (me?.robots || []).some(r=>r.typeId === item.id);
        const card = document.createElement('div');
        card.className = 'glass rounded-3xl p-4';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-black truncate">${item.name}</div>
              <div class="text-xs muted2 mt-1">${item.desc}</div>
            </div>
            <div class="text-[11px] font-extrabold px-3 py-1 rounded-full bg-slate-500/10 muted">
              ${rarityBadge(item.rarity)}
            </div>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Narx</div>
              <div class="font-black">${item.price} coin</div>
            </div>
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Cute</div>
              <div class="font-black">${item.baseCuteness}/100</div>
            </div>
          </div>

          <div class="mt-4">
            <button ${owned ? 'disabled' : ''} data-buy="${item.id}" class="${owned ? 'opacity-60 cursor-not-allowed' : ''} btn-primary text-white rounded-2xl px-4 py-3 text-sm font-extrabold glow w-full">
              ${owned ? 'Sizda bor' : '<i class="fa-solid fa-cart-shopping mr-2"></i>Sotib olish'}
            </button>
          </div>
        `;
        box.appendChild(card);
      });

      box.querySelectorAll('[data-buy]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          try{
            const id = btn.getAttribute('data-buy');
            await apiPost('/api/robots/buy', { robotTypeId: id });
            toast('Robot sotib olindi');
            await reloadAll();
            renderShop();
          }catch(e){ toast(e.message, 'error'); }
        });
      });
    }

    function renderUpgradeList(){
      const box = document.getElementById('upgradeList');
      box.innerHTML = '';
      const entries = Object.values(upgrades || {});
      entries.forEach(up=>{
        const card = document.createElement('div');
        card.className = 'glass rounded-3xl p-4';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-black truncate">${up.name}</div>
              <div class="text-xs muted2 mt-1">${up.desc || ''}</div>
            </div>
            <div class="text-[11px] font-extrabold px-3 py-1 rounded-full bg-slate-500/10 muted">
              ${up.price} coin
            </div>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">Cute</div>
              <div class="font-black">+${up.cutenessPlus || 0}</div>
            </div>
            <div class="glass rounded-2xl px-3 py-2">
              <div class="muted2 font-extrabold">XP</div>
              <div class="font-black">+${up.xpPlus || 0}</div>
            </div>
          </div>
          <div class="mt-4">
            <button data-up="${up.id}" class="btn-primary text-white rounded-2xl px-4 py-3 text-sm font-extrabold glow w-full">
              <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Upgrade qilish
            </button>
          </div>
        `;
        box.appendChild(card);
      });

      box.querySelectorAll('[data-up]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          try{
            const upgradeId = btn.getAttribute('data-up');
            if(!selectedRobotId) return;
            await apiPost('/api/robots/upgrade', { robotId: selectedRobotId, upgradeId });
            toast('Upgrade qilindi');
            await reloadAll();
          }catch(e){ toast(e.message, 'error'); }
        });
      });
    }

    function isSelf(){
      if(!me || !viewed) return false;
      return String(me._id) === String(viewed._id);
    }

    async function reloadAll(){
      await loadMe();
      await loadViewed();
      // coins: only show for self (me coins)
      document.getElementById('coins').textContent = (me?.coins ?? 0);
      fillProfile(viewed);

      // Always show robots collection from viewed user.
      // If viewed is me, refresh robots from /api/robots/me to get equipped status accurately.
      if(isSelf()){
        const rm = await apiGet('/api/robots/me');
        me.robots = rm.robots || [];
        me.activeRobotId = rm.activeRobotId || '';
        // sync viewed to me
        viewed = { ...viewed, robots: me.robots, activeRobotId: me.activeRobotId, activeRobot: rm.active };
        document.getElementById('coins').textContent = rm.coins ?? (me?.coins ?? 0);
        fillProfile(viewed);
      }

      // buttons
      document.getElementById('messageBtn').classList.toggle('hidden', isSelf());
      document.getElementById('editBtn').classList.toggle('hidden', !isSelf());

      document.getElementById('selfRobotActions').classList.toggle('hidden', !isSelf());
      document.getElementById('otherPlayActions').classList.toggle('hidden', isSelf());

      renderRobotGrid(viewed);
    }

    // UI bindings
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('token');
      location.href = '/login.html';
    });

    document.getElementById('shareBtn').addEventListener('click', async ()=>{
      try{
        if(!viewed?._id) return;
        const url = `${location.origin}/profile.html?user=${viewed._id}`;
        await navigator.clipboard.writeText(url);
        toast('Profil havolasi nusxalandi');
      }catch(e){
        toast('Nusxa olinmadi', 'error');
      }
    });

    document.getElementById('refreshRobotsBtn').addEventListener('click', ()=> reloadAll().catch(e=>toast(e.message,'error')));

    document.getElementById('messageBtn').addEventListener('click', ()=>{
      if(!viewed?._id) return;
      location.href = `/chat.html?user=${encodeURIComponent(viewed._id)}`;
    });

    // Edit profile
    const editPanel = document.getElementById('editPanel');
    document.getElementById('editBtn').addEventListener('click', ()=>{
      editPanel.classList.toggle('hidden');
      if(!editPanel.classList.contains('hidden')){
        document.getElementById('fullNameIn').value = me?.fullName || '';
        document.getElementById('nicknameIn').value = me?.nickname || '';
        document.getElementById('usernameIn').value = me?.username || '';
        document.getElementById('phoneIn').value = me?.phone || '';
        document.getElementById('bioIn').value = me?.bio || '';
      }
    });
    document.getElementById('cancelEditBtn').addEventListener('click', ()=> editPanel.classList.add('hidden'));

    document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
      try{
        const payload = {
          fullName: document.getElementById('fullNameIn').value.trim(),
          nickname: document.getElementById('nicknameIn').value.trim(),
          username: document.getElementById('usernameIn').value.trim(),
          phone: document.getElementById('phoneIn').value.trim(),
          bio: document.getElementById('bioIn').value.trim(),
        };
        const r = await apiPut('/api/profile', payload);
        if(r.success){
          toast('Profil saqlandi');
          editPanel.classList.add('hidden');
          await reloadAll();
        } else {
          toast('Saqlanmadi', 'error');
        }
      }catch(e){ toast(e.message,'error'); }
    });

    // Robot shop & upgrade
    document.getElementById('openRobotShopBtn').addEventListener('click', ()=>{
      renderShop();
      openModal('robotShopModal');
    });
    document.getElementById('openUpgradeBtn').addEventListener('click', ()=>{
      // upgrade active robot by default
      const a = (me?.robots || []).find(x=>x.equipped) || (me?.robots || [])[0];
      if(!a) return toast('Robot topilmadi', 'error');
      selectedRobotId = a._id;
      document.getElementById('upgradeTargetName').textContent = a.name || 'Robot';
      renderUpgradeList();
      openModal('upgradeModal');
    });

    // Other play actions (top panel)
    document.querySelectorAll('[data-play]').forEach(btn=>{
      // already bound inside grid for other view; keep also for panel buttons
      if(btn.closest('#otherPlayActions')){
        btn.addEventListener('click', async ()=>{
          try{
            if(!viewed || isSelf()) return;
            const action = btn.getAttribute('data-play');
            const r = await apiPost('/api/robots/play', { targetUserId: viewed._id, action });
            toast(r.message || 'O‘ynaldi');
            setRobotMood(r.reaction || 'neutral');
          }catch(e){ toast(e.message,'error'); }
        });
      }
    });

    // Start
    (async function init(){
      try{
        if(!token()){
          location.href = '/login.html';
          return;
        }
        await loadMe();
        await loadCatalog();
        await loadViewed();
        await reloadAll();
      }catch(e){
        toast(e.message || 'Xatolik', 'error');
        setTimeout(()=> location.href='/login.html', 1200);
      }
    })();
  </script>
</body>
</html>
